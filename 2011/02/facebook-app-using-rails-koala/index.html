
<!DOCTYPE HTML>
<html>
<head>
	<meta charset="utf-8">
	<title>Facebook App by Rails using Koala - Udooz!</title>
    <meta name="author" content="M Sheik Uduman Ali">
    
	<meta name="description" content="To get to know much about developing Facebook applications using a server side, I have chosen with Koala for Rails.  For .NET, Facebook C# SDK is &hellip;">
	
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

	<link href="/atom.xml" rel="alternate" title="Udooz!" type="application/atom+xml">
	<link rel="canonical" href="">
	<link href="/blog/favicon.ico" rel="shortcut icon">
    <link href="/blog/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">

    <link href='http://fonts.googleapis.com/css?family=Slackey' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Fjalla+One' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Amethysta' rel='stylesheet' type='text/css'>
	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>
    <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

    <script type="text/javascript" src="/blog/javascripts/jquery-tapir.js"></script>

    <!-- remove or comment it to disable ajaxification -->   
    <script src="/javascripts/ajaxify.js"></script>
   
    
    

</head>


<body>
    <div id="wrapper">
    <header id="header" class="inner"><!-- for more effects see _animate.scss -->
<h1 class="animated bounceInDown">
    <div id="headerbg">
        M Sheik Uduman Ali
    </div>
</h1>
<br>

<ul id="social-links" style="text-align:center">
  
  
  
  
  
  
  
  
</ul>


<!-- use full url including 'index.html' for navigation bar if you are using ajax -->
<ul id="nav">
	<li id="ajax"><a href="/blog/index.html">Home</a></li>
	<li id="ajax"><a href="/blog/blog/archives/index.html">Archives</a></li>
    <li><a href="/blog/atom.xml">RSS</a></li>
    
    <li>
    <div id="dark">
        <form method="get" action="/blog/search.html" id="search">
            <input name="query" type="text" placeholder="Search..." x-webkit-speech />
        </form>
    </div>
    </li>
        
</ul>




</header>

<div id="toload">
<!-- begin toload --> 
    <div id="content" class="inner">
        <article class="post">
	<h2 class="title">Facebook App by Rails using Koala</h2>
	<div class="entry-content"><p>To get to know much about developing Facebook applications using a server side, I have chosen with Koala for Rails.  For .NET, Facebook C# SDK is being well supported by Microsoft also (<a href="http://facebooksdk.codeplex.com/" target="_blank"><a href="http://facebooksdk.codeplex.com/">http://facebooksdk.codeplex.com/</a></a>).  In this post, I explain how to use Koala in your Rails applications.  As any Facebook app, the prerequisite  are:</p>

<ul>
<li>Facebook account (of course you should be the one in the 10% of world population <img src="http://udooz.net/blog/wp-includes/images/smilies/icon_smile.gif" alt=":)" class="wp-smiley" /> )</li>
<li>A Facebook application (which could be in sandbox mode), so you should have App ID, App Secret and Callback URL</li>
<li>A Rails application in your local machine and the Facebook app pointed to this as <a href="http://localhost:3000">http://localhost:3000</a> (default port for Mongrel or WEBrick)</li>
</ul>


<h2>Installing Koala</h2>

<p>Install Koala gem from <a href="https://github.com/arsduo/koala" target="_blank"><a href="https://github.com/arsduo/koala">https://github.com/arsduo/koala</a></a> by using <strong>sudo gem install koala &#8211;pre</strong></p>

<h2>Configuring Koala</h2>

<p>Create facebook.yml in /config with the following content</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="err">#</span> <span class="nx">config</span><span class="o">/</span><span class="nx">facebook</span><span class="p">.</span><span class="nx">yml</span>
</span><span class='line'><span class="nx">development</span><span class="o">:</span>
</span><span class='line'> <span class="nx">app_id</span><span class="o">:</span> <span class="mi">184</span><span class="nx">xxxxxxxxxxxx</span>
</span><span class='line'> <span class="nx">secret_key</span><span class="o">:</span> <span class="mi">80</span><span class="nx">xxxxxxxxxxxxxxxxxxxxxxxxxxxxxx</span>
</span><span class='line'> <span class="nx">callback_url</span><span class="o">:</span> <span class="nx">http</span><span class="o">:</span><span class="c1">//localhost:3000/</span>
</span><span class='line'><span class="nx">test</span><span class="o">:</span>
</span><span class='line'> <span class="p">...</span>
</span><span class='line'><span class="nx">production</span><span class="o">:</span>
</span><span class='line'> <span class="p">...</span>
</span></code></pre></td></tr></table></div></figure>


<p>Add the following in config/environment.rb</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># config/environment.rb</span>
</span><span class='line'><span class="c1"># in Rails::Initializer.run do |config|</span>
</span><span class='line'><span class="n">config</span><span class="o">.</span><span class="n">action_controller</span><span class="o">.</span><span class="n">allow_forgery_protection</span> <span class="o">=</span> <span class="kp">false</span>
</span><span class='line'><span class="n">config</span><span class="o">.</span><span class="n">gem</span> <span class="s2">&quot;koala&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>The first line enables Facebook callback to your server.  The following line adds koala gem into this application.</p>

<p>Create koala.rb in /config/initializers with the following content</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># config/initializers/koala.rb</span>
</span><span class='line'>
</span><span class='line'><span class="k">module</span> <span class="nn">Facebook</span>
</span><span class='line'> <span class="no">CONFIG</span> <span class="o">=</span> <span class="no">YAML</span><span class="o">.</span><span class="n">load_file</span><span class="p">(</span><span class="no">Rails</span><span class="o">.</span><span class="n">root</span> <span class="o">+</span> <span class="s2">&quot;/config/facebook.yml&quot;</span><span class="p">)</span><span class="o">[</span><span class="no">Rails</span><span class="o">.</span><span class="n">env</span><span class="o">]</span>
</span><span class='line'> <span class="no">APP_ID</span> <span class="o">=</span> <span class="no">CONFIG</span><span class="o">[</span><span class="s1">&#39;app_id&#39;</span><span class="o">]</span>
</span><span class='line'> <span class="no">SECRET</span> <span class="o">=</span> <span class="no">CONFIG</span><span class="o">[</span><span class="s1">&#39;secret_key&#39;</span><span class="o">]</span>
</span><span class='line'> <span class="no">CALLBACK_URL</span> <span class="o">=</span> <span class="no">CONFIG</span><span class="o">[</span><span class="s1">&#39;callback_url&#39;</span><span class="o">]</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="no">Koala</span><span class="o">::</span><span class="no">Facebook</span><span class="o">::</span><span class="no">OAuth</span><span class="o">.</span><span class="n">class_eval</span> <span class="k">do</span>
</span><span class='line'> <span class="k">def</span> <span class="nf">initialize_with_default_settings</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
</span><span class='line'> <span class="k">case</span> <span class="n">args</span><span class="o">.</span><span class="n">size</span>
</span><span class='line'> <span class="k">when</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span>
</span><span class='line'> <span class="k">raise</span> <span class="s2">&quot;application id and/or secret are not specified in the config&quot;</span> <span class="k">unless</span> <span class="no">Facebook</span><span class="o">::</span><span class="no">APP_ID</span> <span class="o">&amp;&amp;</span> <span class="no">Facebook</span><span class="o">::</span><span class="no">SECRET</span>
</span><span class='line'> <span class="n">initialize_without_default_settings</span><span class="p">(</span><span class="no">Facebook</span><span class="o">::</span><span class="no">APP_ID</span><span class="o">.</span><span class="n">to_s</span><span class="p">,</span> <span class="no">Facebook</span><span class="o">::</span><span class="no">SECRET</span><span class="o">.</span><span class="n">to_s</span><span class="p">,</span> <span class="no">Facebook</span><span class="o">::</span><span class="no">CALLBACK_URL</span><span class="o">.</span><span class="n">to_s</span><span class="p">)</span>
</span><span class='line'> <span class="k">when</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span>
</span><span class='line'> <span class="n">initialize_without_default_settings</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
</span><span class='line'> <span class="k">end</span>
</span><span class='line'> <span class="k">end</span>
</span><span class='line'>
</span><span class='line'> <span class="n">alias_method_chain</span> <span class="ss">:initialize</span><span class="p">,</span> <span class="ss">:default_settings</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>The above code loads the Facebook.yml settings into Facebook, so you can access AppID, AppSecret and CallbackURL anywhere in your application in an unified way.  The following OAuth extension method is taken from Koala guidance to simplify the instantiation of OAuth.new.</p>

<h2>Controller Part</h2>

<p>In ApplicationController, add the following</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1">#app/controller/application.rb</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># protect_from_forgery</span>
</span><span class='line'>
</span><span class='line'><span class="n">before_filter</span> <span class="ss">:parse_facebook_cookies</span>
</span><span class='line'><span class="k">def</span> <span class="nf">parse_facebook_cookies</span>
</span><span class='line'> <span class="vi">@facebook_cookies</span> <span class="o">=</span> <span class="no">Koala</span><span class="o">::</span><span class="no">Facebook</span><span class="o">::</span><span class="no">OAuth</span><span class="o">.</span><span class="n">new</span><span class="o">.</span><span class="n">get_user_info_from_cookie</span><span class="p">(</span><span class="n">cookies</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Note that protect_from_forgery has been commented.  The following instructions, let this application load OAuth details from cookies for getting Facebook access token.</p>

<h2>Your Login Page</h2>

<p>Add the following on your login page layout, in this case /app/views/layout/login.html.erb</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="nt">&lt;html</span> <span class="na">xmlns=</span><span class="s">&quot;http://www.w3.org/1999/xhtml&quot;</span> <span class="na">xml:lang=</span><span class="s">&quot;en&quot;</span> <span class="na">lang=</span><span class="s">&quot;en&quot;</span>
</span><span class='line'> <span class="na">xml:fb=</span><span class="s">&quot;http://www.facebook.com/2008/fbml&quot;</span><span class="nt">&gt;</span>
</span><span class='line'><span class="nt">&lt;head&gt;</span>
</span><span class='line'> <span class="nt">&lt;meta</span> <span class="na">http-equiv=</span><span class="s">&quot;content-type&quot;</span> <span class="na">content=</span><span class="s">&quot;text/html;charset=UTF-8&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'> <span class="nt">&lt;title&gt;</span>Udooz Sample<span class="nt">&lt;/title&gt;</span>
</span><span class='line'> <span class="nt">&lt;script</span> <span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span> <span class="na">src=</span><span class="s">&quot;http://connect.facebook.net/en_US/all.js&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
</span><span class='line'><span class="nt">&lt;/head&gt;</span>
</span><span class='line'><span class="nt">&lt;body&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;p</span> <span class="na">style=</span><span class="s">&quot;color: green&quot;</span><span class="nt">&gt;</span><span class="err">&lt;</span>%= flash[:notice] %&gt;<span class="nt">&lt;/p&gt;</span>
</span><span class='line'><span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;fb-root&quot;</span><span class="nt">&gt;&lt;/div&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;script</span> <span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span><span class="nt">&gt;</span>
</span><span class='line'> FB.init({
</span><span class='line'> appId  : &#39;<span class="err">&lt;</span>%= Facebook::APP_ID %&gt;&#39;,
</span><span class='line'> status : true, // check login status
</span><span class='line'> cookie : true, // enable cookies to allow the server to access the session
</span><span class='line'> xfbml  : true  // parse XFBML
</span><span class='line'> });
</span><span class='line'>
</span><span class='line'> FB.login(function(response) {
</span><span class='line'> if (response.session) {
</span><span class='line'> location.href = &#39;/home&#39;
</span><span class='line'> } else {
</span><span class='line'> // user cancelled login
</span><span class='line'> }
</span><span class='line'>});
</span><span class='line'><span class="nt">&lt;/script&gt;</span>
</span><span class='line'><span class="nt">&lt;h1&gt;</span>udooz<span class="nt">&lt;/h1&gt;</span>
</span><span class='line'><span class="nt">&lt;/body&gt;</span>
</span><span class='line'><span class="nt">&lt;/html&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>In this example, I&#8217;ve used Facebook JavaScript SDK for login screen.  To use this, I&#8217;ve include FBML scheme in <html> as xml:fb=&#8221;<a href="http://www.facebook.com/2008/fbml&amp;#8221;">http://www.facebook.com/2008/fbml&amp;#8221;</a> followed by referring Facebook SDK script file.</p>

<h2>You Home Page</h2>

<p>In your home page, add the following things.</p>

<p>In app/controllers/HomeController.rb</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">HomeController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">index</span>
</span><span class='line'>    <span class="n">graph</span> <span class="o">=</span> <span class="no">Koala</span><span class="o">::</span><span class="no">Facebook</span><span class="o">::</span><span class="no">GraphAPI</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="vi">@facebook_cookies</span><span class="o">[</span><span class="s2">&quot;access_token&quot;</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>    <span class="vi">@likes</span> <span class="o">=</span> <span class="n">graph</span><span class="o">.</span><span class="n">get_connections</span><span class="p">(</span><span class="s2">&quot;me&quot;</span><span class="p">,</span> <span class="s2">&quot;likes&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>In the above code, new Graph instance has been created.  By using this, I&#8217;ve invoked the currently logged in user&#8217;s likes.</p>

<p>In app/views/home.html.erb</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="nt">&lt;table</span> <span class="na">border=</span><span class="s">&quot;0&quot;</span><span class="nt">&gt;</span>
</span><span class='line'> <span class="err">&lt;</span>% if @likes %&gt;
</span><span class='line'> <span class="err">&lt;</span>% for like in @likes %&gt;
</span><span class='line'> <span class="nt">&lt;tr&gt;</span>
</span><span class='line'> <span class="nt">&lt;td&gt;&lt;b&gt;</span><span class="err">&lt;</span>%=h like[&quot;name&quot;]%&gt; <span class="nt">&lt;/b&gt;&lt;/td&gt;</span>
</span><span class='line'> <span class="nt">&lt;/tr&gt;</span>
</span><span class='line'> <span class="nt">&lt;tr&gt;</span>
</span><span class='line'> <span class="nt">&lt;td&gt;</span><span class="err">&lt;</span>%=h like[&quot;category&quot;] %&gt;<span class="nt">&lt;/td&gt;</span>
</span><span class='line'> <span class="nt">&lt;/tr&gt;</span>
</span><span class='line'> <span class="nt">&lt;tr&gt;</span>
</span><span class='line'> <span class="nt">&lt;td&gt;</span><span class="ni">&amp;ndash;</span><span class="nt">&lt;/td&gt;</span>
</span><span class='line'> <span class="nt">&lt;/tr&gt;</span>
</span><span class='line'> <span class="err">&lt;</span>% end %&gt;
</span><span class='line'> <span class="err">&lt;</span>% end %&gt;
</span><span class='line'><span class="nt">&lt;/table&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now, run your application.  Hope it would be easy.<br/>
<a href="http://www.codeproject.com/script/Articles/BlogFeedList.aspx?amid=3057856" style="display:none" rel="tag">CodeProject</a></p>
</div>

<div class="meta">
	
</div>
</article>

	<div class="share">
	<div class="addthis_toolbox addthis_default_style ">
	
	
	<a class="addthis_button_tweet"></a>
	
	
	<a class="addthis_counter addthis_pill_style"></a>
	</div>
  <script type="text/javascript" src="http://s7.addthis.com/js/250/addthis_widget.js#pubid="></script>
</div>



    </div>
    <footer id="footer">
    <div style="display:inline">
    Copyright &copy; 2014

    M Sheik Uduman Ali
. Powered by <a href="http://octopress.org">Octopress</a> | 
    Theme <a href="http://github.com/panks/fabric">fabric</a> by <a href="http://panks.me">Pankaj Kumar</a>
</div>


    </footer>
    <script src="/blog/javascripts/fabric.js"></script>
<script src="/blog/javascripts/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
	$('.fancybox').fancybox();
})(jQuery);
</script> <!-- Delete or comment this line to disable Fancybox -->






<!-- end toload --> 
</div>
</div>
<script src="/javascripts/jquery.ui.totop.js" type="text/javascript"></script>
<script type="text/javascript">
/*<![CDATA[*/
;(function($){$().UItoTop({easingType:'easeOutCirc'});})(jQuery); 
/*]]>*/
</script><!-- remove it to remove the scroll to top button -->
</body>
</html>
