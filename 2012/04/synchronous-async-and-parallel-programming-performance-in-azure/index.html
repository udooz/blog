
<!DOCTYPE HTML>
<html>
<head>
	<meta charset="utf-8">
	<title>Synchronous, Async and Parallel Programming Performance in Windows Azure - Udooz!</title>
    <meta name="author" content="M Sheik Uduman Ali">
    
	<meta name="description" content="This post discusses the performance benefits of effectively using .NET TPL  when doing I/O bound operations. Intent When there is a need for non- &hellip;">
	
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

	<link href="/atom.xml" rel="alternate" title="Udooz!" type="application/atom+xml">
	<link rel="canonical" href="">
	<link href="/blog/favicon.ico" rel="shortcut icon">
    <link href="/blog/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">

    <link href='http://fonts.googleapis.com/css?family=Slackey' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Fjalla+One' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Amethysta' rel='stylesheet' type='text/css'>
	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>
    <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

    <script type="text/javascript" src="/blog/javascripts/jquery-tapir.js"></script>

    <!-- remove or comment it to disable ajaxification -->   
    <script src="/javascripts/ajaxify.js"></script>
   
    
    

</head>


<body>
    <div id="wrapper">
    <header id="header" class="inner"><!-- for more effects see _animate.scss -->
<h1 class="animated bounceInDown">
    <div id="headerbg">
        Udooz!
    </div>
</h1>
<br>

<ul id="social-links" style="text-align:center">
  
  
  
  
  
  
  
  
</ul>


<!-- use full url including 'index.html' for navigation bar if you are using ajax -->
<ul id="nav">
	<li id="ajax"><a href="/blog/index.html">Home</a></li>
	<li id="ajax"><a href="/blog/blog/archives/index.html">Archives</a></li>
    <li><a href="/blog/atom.xml">RSS</a></li>
    
    <li>
    <div id="dark">
        <form method="get" action="/blog/search.html" id="search">
            <input name="query" type="text" placeholder="Search..." x-webkit-speech />
        </form>
    </div>
    </li>
        
</ul>




</header>

<div id="toload">
<!-- begin toload --> 
    <div id="content" class="inner">
        <article class="post">
	<h2 class="title">Synchronous, Async and Parallel Programming Performance in Windows Azure</h2>
	<div class="entry-content"><p>This post discusses the performance benefits of effectively using .NET TPL  when doing I/O bound operations.</p>

<h2>Intent</h2>

<p>When there is a need for non-synchronous programming pattern (asynchronous and/or parallel) in Azure applications, the pattern of choice must be based on the target VM size we have chosen for that app and the type of operation particular part does.</p>

<h2>Detail</h2>

<p>.NET provides TPL (Task Parallel Library) to write non-synchronous programming much easier way. The asynchronous API enables to perform I/O bound and compute-bound asynchronous operations which lets the main thread to do the remaining operations without waiting for the asynchronous operations to complete. Refer <a href="http://snip.udooz.net/Hbmib2" target="_blank"><a href="http://snip.udooz.net/Hbmib2">http://snip.udooz.net/Hbmib2</a></a> for details. The parallel API enables to effectively utilizes the multicore processors on your machine to perform data intensive or task intensive operations. Refer <a href="http://snip.udooz.net/HTLrVv" target="_blank"><a href="http://snip.udooz.net/HTLrVv">http://snip.udooz.net/HTLrVv</a></a> for details.</p>

<p>When writing azure applications, we may need to interact with many external resources like blob, queues, tables, etc. So, it is very obvious to think asynchronous or parallel programming patterns when the amount of I/O operations are higher. In these cases, we should be more cautious on selecting asynchronous and parallel. The extra-small instance provides shared CPU power, the small instance provides single core and medium or above provide multicore. Hence, asynchronous pattern would be the better option for extra-small and small instances. For problem those are highly parallel in nature, then the application should be placed on Medium or above instance with parallel pattern.</p>

<p>To confirm the above statement, I did a small proof of concept which has high I/O operation. The program interacts with Azure blob to get large number of blobs to get data to solve a problem. I&#8217;ve taken a small amount of Enron Email dataset from <a href="http://www.cs.cmu.edu/~enron/" target="_blank"><a href="http://www.cs.cmu.edu/~enron/">http://www.cs.cmu.edu/~enron/</a></a> which contains email messages for various Enron users on their respective Inbox folder as shown in figure 1 and figure 2.</p>

<p><a href="http://udooz.github.io//blog/images/2012/04/async_figure_1.png" rel="prettyPhoto[381]"><img class="alignnone size-full wp-image-382" style="border-image: initial; border-width: 1px; border-color: black; border-style: solid;" title="async_figure_1" src="http://udooz.github.io//blog/images/2012/04/async_figure_1.png" alt="" width="202" height="183" /></a></p>

<p><a href="http://udooz.github.io//blog/images/2012/04/async_figure_2.png" rel="prettyPhoto[381]"><img class="alignnone size-full wp-image-383" style="border-image: initial; border-width: 1px; border-color: black; border-style: solid;" title="async_figure_2" src="http://udooz.github.io//blog/images/2012/04/async_figure_2.png" alt="" width="320" height="193" /></a></p>

<p>The above figure shows the “inbox” for the user “benson-r”. Every users have approximately more than 200 email messages. A message contains the following content:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>>Message-ID: &lt;21651803.1075842014433.JavaMail.evans@thyme>
</span><span class='line'>Date: Tue, 5 Feb 2002 11:06:50 -0800 (PST)
</span><span class='line'>From: robert.stalford@enron.com
</span><span class='line'>To: jay.webb@enron.com
</span><span class='line'>Subject: online power option change request
</span><span class='line'>Cc: andy.zipper@enron.com
</span><span class='line'>Mime-Version: 1.0
</span><span class='line'>Content-Type: text/plain; charset=us-ascii
</span><span class='line'>Content-Transfer-Encoding: 7bit
</span><span class='line'>======= OTHER HEADERS=======
</span><span class='line'>Jay,
</span><span class='line'>It was ..... ====== remaining message body ======</span></code></pre></td></tr></table></div></figure>


<p>The program going to solve how many times particular user written email to this user. The email messages are resided in a blob container with appropriate blob directory. Hence, the pseudo code is some thing like:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">for</span> <span class="n">every</span> <span class="n">user</span>
</span><span class='line'>  <span class="k">get</span> <span class="n">the</span> <span class="n">blob</span> <span class="n">sub</span><span class="p">-</span><span class="n">directory</span> <span class="k">for</span> <span class="n">the</span> <span class="n">user</span> <span class="k">from</span> <span class="n">the</span> <span class="n">blob</span> <span class="n">container</span>
</span><span class='line'>  <span class="n">create</span> <span class="k">new</span> <span class="n">dictionary</span> <span class="c1">// key - sender email ID, value - count</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">for</span> <span class="n">every</span> <span class="n">blob</span> <span class="k">in</span> <span class="n">the</span> <span class="n">sub</span><span class="p">-</span><span class="n">directory</span>
</span><span class='line'>      <span class="k">get</span> <span class="n">blob</span> <span class="n">content</span>
</span><span class='line'>      <span class="n">parse</span> <span class="n">the</span> <span class="err">“</span><span class="n">From</span><span class="err">”</span> <span class="k">value</span> <span class="k">from</span> <span class="n">the</span> <span class="n">message</span>
</span><span class='line'>      <span class="k">if</span> <span class="n">the</span> <span class="err">“</span><span class="n">From</span><span class="err">”</span> <span class="k">value</span> <span class="n">already</span> <span class="n">exists</span> <span class="n">on</span> <span class="n">dictionary</span>
</span><span class='line'>          <span class="n">increment</span> <span class="n">the</span> <span class="k">value</span> <span class="n">by</span> <span class="m">1</span>
</span><span class='line'>      <span class="k">else</span>
</span><span class='line'>          <span class="k">add</span> <span class="n">From</span> <span class="n">field</span> <span class="k">value</span> <span class="k">as</span> <span class="n">key</span> <span class="n">and</span> <span class="k">value</span> <span class="k">as</span> <span class="m">1</span> <span class="k">into</span> <span class="n">the</span> <span class="n">dictionary</span>
</span><span class='line'>  <span class="n">write</span> <span class="n">the</span> <span class="n">result</span>
</span></code></pre></td></tr></table></div></figure>


<p>I apply “sync, async and parallel” along with normal Task.StartNew and Task.StartNew + ContinueWith programming patterns on &#8220;fetching and parsing email messages&#8221; logic (more chatty I/O).</p>

<h2>The Code</h2>

<p>The normal procedural flow is shown below:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="c1">// rootContainer is CloudBlobDirectory represents &quot;maildir&quot; container</span>
</span><span class='line'><span class="kt">var</span> <span class="n">mailerInbox</span> <span class="p">=</span> <span class="n">rootContainer</span><span class="p">.</span><span class="n">GetSubdirectory</span><span class="p">(</span><span class="n">mailerFolder</span> <span class="p">+</span> <span class="s">&quot;/inbox&quot;</span><span class="p">);</span>
</span><span class='line'><span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">blob</span> <span class="k">in</span> <span class="n">mailerInbox</span><span class="p">.</span><span class="n">ListBlobs</span><span class="p">())</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'> <span class="c1">//don&#39;t see the subfolders if any</span>
</span><span class='line'> <span class="k">if</span> <span class="p">(</span><span class="n">blob</span> <span class="k">is</span> <span class="n">CloudBlobDirectory</span><span class="p">)</span> <span class="k">continue</span><span class="p">;</span>
</span><span class='line'> <span class="kt">var</span> <span class="n">email</span> <span class="p">=</span> <span class="n">mailerInbox</span><span class="p">.</span><span class="n">GetBlobReference</span><span class="p">(</span><span class="n">blob</span><span class="p">.</span><span class="n">Uri</span><span class="p">.</span><span class="n">ToString</span><span class="p">()).</span><span class="n">DownloadText</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'> <span class="c1">//parsing From field</span>
</span><span class='line'> <span class="kt">var</span> <span class="n">match</span> <span class="p">=</span> <span class="n">Regex</span><span class="p">.</span><span class="n">Match</span><span class="p">(</span><span class="n">email</span><span class="p">,</span> <span class="s">@&quot;From\W*(\w[-.\w]*@[-a-z0-9]+(\.[-a-z0-9]+)*)&quot;</span><span class="p">);</span>
</span><span class='line'> <span class="k">if</span> <span class="p">(</span><span class="n">match</span><span class="p">.</span><span class="n">Groups</span><span class="p">.</span><span class="n">Count</span> <span class="p">&gt;</span> <span class="m">0</span><span class="p">)</span>
</span><span class='line'> <span class="p">{</span>
</span><span class='line'> <span class="kt">var</span> <span class="n">key</span> <span class="p">=</span> <span class="n">match</span><span class="p">.</span><span class="n">Groups</span><span class="p">[</span><span class="m">1</span><span class="p">].</span><span class="n">Value</span><span class="p">;</span>
</span><span class='line'> <span class="c1">//estimate is a Dictionary contains From email id and the count</span>
</span><span class='line'> <span class="k">if</span> <span class="p">(</span><span class="n">estimate</span><span class="p">.</span><span class="n">ContainsKey</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
</span><span class='line'> <span class="n">estimate</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="p">=</span> <span class="n">estimate</span><span class="p">[</span><span class="n">key</span><span class="p">]++;</span>
</span><span class='line'> <span class="k">else</span>
</span><span class='line'> <span class="n">estimate</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="m">1</span><span class="p">);</span>
</span><span class='line'> <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="kt">var</span> <span class="n">sb</span> <span class="p">=</span> <span class="k">new</span> <span class="n">StringBuilder</span><span class="p">();</span>
</span><span class='line'><span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">kv</span> <span class="k">in</span> <span class="n">estimate</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'> <span class="n">sb</span><span class="p">.</span><span class="n">AppendFormat</span><span class="p">(</span><span class="s">&quot;{0}: {1}\n&quot;</span><span class="p">,</span> <span class="n">kv</span><span class="p">.</span><span class="n">Key</span><span class="p">,</span> <span class="n">kv</span><span class="p">.</span><span class="n">Value</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="c1">//writing the result to a blob</span>
</span><span class='line'><span class="kt">var</span> <span class="n">result</span> <span class="p">=</span> <span class="n">mailerInbox</span><span class="p">.</span><span class="n">GetBlobReference</span><span class="p">(</span><span class="s">&quot;result_normal_&quot;</span> <span class="p">+</span> <span class="n">attempt</span><span class="p">);</span>
</span><span class='line'><span class="n">result</span><span class="p">.</span><span class="n">UploadText</span><span class="p">(</span><span class="n">sb</span><span class="p">.</span><span class="n">ToString</span><span class="p">());</span>
</span></code></pre></td></tr></table></div></figure>


<p>The parallel version is shown below:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="kt">var</span> <span class="n">mailerInbox</span> <span class="p">=</span> <span class="n">rootContainer</span><span class="p">.</span><span class="n">GetSubdirectory</span><span class="p">(</span><span class="n">mailerFolder</span> <span class="p">+</span> <span class="s">&quot;/inbox&quot;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="n">Parallel</span><span class="p">.</span><span class="n">ForEach</span><span class="p">(</span><span class="n">mailerInbox</span><span class="p">.</span><span class="n">ListBlobs</span><span class="p">(),</span> <span class="n">blob</span> <span class="p">=&gt;</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'> <span class="k">if</span> <span class="p">(!(</span><span class="n">blob</span> <span class="k">is</span> <span class="n">CloudBlobDirectory</span><span class="p">))</span>
</span><span class='line'> <span class="p">{</span>
</span><span class='line'> <span class="kt">var</span> <span class="n">email</span> <span class="p">=</span> <span class="n">mailerInbox</span><span class="p">.</span><span class="n">GetBlobReference</span><span class="p">(</span><span class="n">blob</span><span class="p">.</span><span class="n">Uri</span><span class="p">.</span><span class="n">ToString</span><span class="p">()).</span><span class="n">DownloadText</span><span class="p">();</span>
</span><span class='line'> <span class="kt">var</span> <span class="n">match</span> <span class="p">=</span> <span class="n">Regex</span><span class="p">.</span><span class="n">Match</span><span class="p">(</span><span class="n">email</span><span class="p">,</span> <span class="s">@&quot;From\W*(\w[-.\w]*@[-a-z0-9]+(\.[-a-z0-9]+)*)&quot;</span><span class="p">);</span>
</span><span class='line'> <span class="k">if</span> <span class="p">(</span><span class="n">match</span><span class="p">.</span><span class="n">Groups</span><span class="p">.</span><span class="n">Count</span> <span class="p">&gt;</span> <span class="m">0</span><span class="p">)</span>
</span><span class='line'> <span class="p">{</span>
</span><span class='line'> <span class="kt">var</span> <span class="n">key</span> <span class="p">=</span> <span class="n">match</span><span class="p">.</span><span class="n">Groups</span><span class="p">[</span><span class="m">1</span><span class="p">].</span><span class="n">Value</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// used ConcurrentDictionary</span>
</span><span class='line'> <span class="n">cestimate</span><span class="p">.</span><span class="n">AddOrUpdate</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="m">1</span><span class="p">,</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="n">v</span><span class="p">++);</span>
</span><span class='line'> <span class="p">}</span>
</span><span class='line'> <span class="p">}</span>
</span><span class='line'><span class="p">});</span>
</span><span class='line'>
</span><span class='line'><span class="c1">//the result writing part is here, similar to normal version</span>
</span></code></pre></td></tr></table></div></figure>


<p>The asynchronous version is:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="kt">var</span> <span class="n">mailerInbox</span> <span class="p">=</span> <span class="n">rootContainer</span><span class="p">.</span><span class="n">GetSubdirectory</span><span class="p">(</span><span class="n">mailerFolder</span> <span class="p">+</span> <span class="s">&quot;/inbox&quot;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="kt">var</span> <span class="n">tasks</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Queue</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'><span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">blob</span> <span class="k">in</span> <span class="n">mailerInbox</span><span class="p">.</span><span class="n">ListBlobs</span><span class="p">())</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'> <span class="k">if</span> <span class="p">(</span><span class="n">blob</span> <span class="k">is</span> <span class="n">CloudBlobDirectory</span><span class="p">)</span> <span class="k">continue</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// blobStorage is a wrapper for Azure Blob storage REST API</span>
</span><span class='line'> <span class="kt">var</span> <span class="n">webRequest</span> <span class="p">=</span> <span class="n">blobStorage</span><span class="p">.</span><span class="n">GetWebRequest</span><span class="p">(</span><span class="n">blob</span><span class="p">.</span><span class="n">Uri</span><span class="p">.</span><span class="n">ToString</span><span class="p">());</span>
</span><span class='line'>
</span><span class='line'><span class="n">tasks</span><span class="p">.</span><span class="n">Enqueue</span><span class="p">(</span><span class="n">Task</span><span class="p">.</span><span class="n">Factory</span><span class="p">.</span><span class="n">FromAsync</span><span class="p">(</span><span class="n">webRequest</span><span class="p">.</span><span class="n">BeginGetResponse</span><span class="p">,</span>
</span><span class='line'> <span class="n">webRequest</span><span class="p">.</span><span class="n">EndGetResponse</span><span class="p">,</span> <span class="n">TaskCreationOptions</span><span class="p">.</span><span class="n">None</span><span class="p">)</span>
</span><span class='line'> <span class="p">.</span><span class="n">ContinueWith</span><span class="p">(</span><span class="n">t</span> <span class="p">=&gt;</span>
</span><span class='line'> <span class="p">{</span>
</span><span class='line'> <span class="kt">var</span> <span class="n">response</span> <span class="p">=</span> <span class="n">t</span><span class="p">.</span><span class="n">Result</span><span class="p">;</span>
</span><span class='line'> <span class="kt">var</span> <span class="n">stream</span> <span class="p">=</span> <span class="k">new</span> <span class="n">StreamReader</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="n">GetResponseStream</span><span class="p">());</span>
</span><span class='line'> <span class="kt">var</span> <span class="n">emailMsg</span> <span class="p">=</span> <span class="n">stream</span><span class="p">.</span><span class="n">ReadToEnd</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'><span class="n">stream</span><span class="p">.</span><span class="n">Close</span><span class="p">();</span>
</span><span class='line'> <span class="n">response</span><span class="p">.</span><span class="n">Close</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'><span class="kt">var</span> <span class="n">match</span> <span class="p">=</span> <span class="n">regex</span><span class="p">.</span><span class="n">Match</span><span class="p">(</span><span class="n">emailMsg</span><span class="p">);</span>
</span><span class='line'> <span class="k">if</span> <span class="p">(</span><span class="n">match</span><span class="p">.</span><span class="n">Groups</span><span class="p">.</span><span class="n">Count</span> <span class="p">&gt;</span> <span class="m">0</span><span class="p">)</span>
</span><span class='line'> <span class="p">{</span>
</span><span class='line'> <span class="kt">var</span> <span class="n">key</span> <span class="p">=</span> <span class="n">match</span><span class="p">.</span><span class="n">Groups</span><span class="p">[</span><span class="m">1</span><span class="p">].</span><span class="n">Value</span><span class="p">;</span>
</span><span class='line'> <span class="n">cestimate</span><span class="p">.</span><span class="n">AddOrUpdate</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="m">1</span><span class="p">,</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="n">v</span><span class="p">++);</span>
</span><span class='line'> <span class="p">}</span>
</span><span class='line'> <span class="p">}));</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">Task</span><span class="p">.</span><span class="n">WaitAll</span><span class="p">(</span><span class="n">tasks</span><span class="p">.</span><span class="n">ToArray</span><span class="p">());</span>
</span></code></pre></td></tr></table></div></figure>


<p>The major difference in the &#8220;fetching and parsing&#8221; part is, instead of managed API, I have used REST API with a wrapper so that I can access the Blob asynchronously. In addition the above, I have used normal TPL tasks in two different way.  In the first way, I just processed &#8220;fetching and parsing&#8221; stuff as shown below:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">blob</span> <span class="k">in</span> <span class="n">mailerInbox</span><span class="p">.</span><span class="n">ListBlobs</span><span class="p">())</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'> <span class="k">if</span> <span class="p">(</span><span class="n">blob</span> <span class="k">is</span> <span class="n">CloudBlobDirectory</span><span class="p">)</span> <span class="k">continue</span><span class="p">;</span>
</span><span class='line'> <span class="kt">string</span> <span class="n">blobUri</span> <span class="p">=</span> <span class="n">blob</span><span class="p">.</span><span class="n">Uri</span><span class="p">.</span><span class="n">ToString</span><span class="p">();</span>
</span><span class='line'> <span class="n">tasks</span><span class="p">.</span><span class="n">Enqueue</span><span class="p">(</span><span class="n">Task</span><span class="p">.</span><span class="n">Factory</span><span class="p">.</span><span class="n">StartNew</span><span class="p">(()</span> <span class="p">=&gt;</span>
</span><span class='line'> <span class="p">{</span>
</span><span class='line'> <span class="kt">var</span> <span class="n">email</span> <span class="p">=</span> <span class="n">mailerInbox</span><span class="p">.</span><span class="n">GetBlobReference</span><span class="p">(</span><span class="n">blobUri</span><span class="p">).</span><span class="n">DownloadText</span><span class="p">();</span>
</span><span class='line'> <span class="kt">var</span> <span class="n">match</span> <span class="p">=</span> <span class="n">Regex</span><span class="p">.</span><span class="n">Match</span><span class="p">(</span><span class="n">email</span><span class="p">,</span> <span class="s">@&quot;From\W*(\w[-.\w]*@[-a-z0-9]+(\.[-a-z0-9]+)*)&quot;</span><span class="p">);</span>
</span><span class='line'> <span class="k">if</span> <span class="p">(</span><span class="n">match</span><span class="p">.</span><span class="n">Groups</span><span class="p">.</span><span class="n">Count</span> <span class="p">&gt;</span> <span class="m">0</span><span class="p">)</span>
</span><span class='line'> <span class="p">{</span>
</span><span class='line'> <span class="kt">var</span> <span class="n">key</span> <span class="p">=</span> <span class="n">match</span><span class="p">.</span><span class="n">Groups</span><span class="p">[</span><span class="m">1</span><span class="p">].</span><span class="n">Value</span><span class="p">;</span>
</span><span class='line'> <span class="n">cestimate</span><span class="p">.</span><span class="n">AddOrUpdate</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="m">1</span><span class="p">,</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="n">v</span><span class="p">++);</span>
</span><span class='line'> <span class="p">}</span>
</span><span class='line'> <span class="p">}));</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">Task</span><span class="p">.</span><span class="n">WaitAll</span><span class="p">(</span><span class="n">tasks</span><span class="p">.</span><span class="n">ToArray</span><span class="p">());</span>
</span></code></pre></td></tr></table></div></figure>


<p>Another one way, I have used ContinueWith option with the Task as shown below:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">blob</span> <span class="k">in</span> <span class="n">mailerInbox</span><span class="p">.</span><span class="n">ListBlobs</span><span class="p">())</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'> <span class="k">if</span> <span class="p">(</span><span class="n">blob</span> <span class="k">is</span> <span class="n">CloudBlobDirectory</span><span class="p">)</span> <span class="k">continue</span><span class="p">;</span>
</span><span class='line'> <span class="kt">string</span> <span class="n">blobUri</span> <span class="p">=</span> <span class="n">blob</span><span class="p">.</span><span class="n">Uri</span><span class="p">.</span><span class="n">ToString</span><span class="p">();</span>
</span><span class='line'> <span class="n">tasks</span><span class="p">.</span><span class="n">Enqueue</span><span class="p">(</span><span class="n">Task</span><span class="p">.</span><span class="n">Factory</span><span class="p">.</span><span class="n">StartNew</span><span class="p">(()</span> <span class="p">=&gt;</span>
</span><span class='line'> <span class="p">{</span>
</span><span class='line'> <span class="k">return</span> <span class="n">mailerInbox</span><span class="p">.</span><span class="n">GetBlobReference</span><span class="p">(</span><span class="n">blobUri</span><span class="p">).</span><span class="n">DownloadText</span><span class="p">();</span>
</span><span class='line'> <span class="p">}).</span><span class="n">ContinueWith</span><span class="p">(</span><span class="n">t</span> <span class="p">=&gt;</span>
</span><span class='line'> <span class="p">{</span>
</span><span class='line'> <span class="kt">var</span> <span class="n">match</span> <span class="p">=</span> <span class="n">regex</span><span class="p">.</span><span class="n">Match</span><span class="p">(</span><span class="n">t</span><span class="p">.</span><span class="n">Result</span><span class="p">);</span>
</span><span class='line'> <span class="k">if</span> <span class="p">(</span><span class="n">match</span><span class="p">.</span><span class="n">Groups</span><span class="p">.</span><span class="n">Count</span> <span class="p">&gt;</span> <span class="m">0</span><span class="p">)</span>
</span><span class='line'> <span class="p">{</span>
</span><span class='line'> <span class="kt">var</span> <span class="n">key</span> <span class="p">=</span> <span class="n">match</span><span class="p">.</span><span class="n">Groups</span><span class="p">[</span><span class="m">1</span><span class="p">].</span><span class="n">Value</span><span class="p">;</span>
</span><span class='line'> <span class="n">cestimate</span><span class="p">.</span><span class="n">AddOrUpdate</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="m">1</span><span class="p">,</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="n">v</span><span class="p">++);</span>
</span><span class='line'> <span class="p">}</span>
</span><span class='line'> <span class="p">},</span> <span class="n">TaskContinuationOptions</span><span class="p">.</span><span class="n">OnlyOnRanToCompletion</span><span class="p">));</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">Task</span><span class="p">.</span><span class="n">WaitAll</span><span class="p">(</span><span class="n">tasks</span><span class="p">.</span><span class="n">ToArray</span><span class="p">());</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Results</h2>

<p>I&#8217;ve hosted the work role and storage account at &#8220;Southeast Asia&#8221;.  On every VM size, I&#8217;ve made 6 runs and removed the first time result.  I have given 12 concurrent connection in the ServicePointManager for all the testing.  I did not change this value in medium and large instances. All the results are in millisecond.</p>

<h3>Extra Small</h3>

<table width="461" border="0" cellspacing="0" cellpadding="0">
  <colgroup> <col span="4" width="64" /> <col width="66" /> <col width="139" /></colgroup> <tr>
    <td width="64" height="20">
    </td>
    
    <td width="64">
      Normal
    </td>
    
    <td width="64">
      Parallel
    </td>
    
    <td width="64">
      Async
    </td>
    
    <td width="66">
      Task
    </td>
    
    <td width="139">
      Task & ContinueWith
    </td>
  </tr>
  
  <tr>
    <td height="20">
      Run 1
    </td>
    
    <td>
      4326
    </td>
    
    <td>
      1209
    </td>
    
    <td>
      1004
    </td>
    
    <td>
      1807
    </td>
    
    <td>
      1671
    </td>
  </tr>
  
  <tr>
    <td height="20">
      Run 2
    </td>
    
    <td>
      4773
    </td>
    
    <td>
      1319
    </td>
    
    <td>
      972
    </td>
    
    <td>
      1399
    </td>
    
    <td>
      1887
    </td>
  </tr>
  
  <tr>
    <td height="20">
      Run 3
    </td>
    
    <td>
      4189
    </td>
    
    <td>
      1027
    </td>
    
    <td>
      1050
    </td>
    
    <td>
      1590
    </td>
    
    <td>
      1322
    </td>
  </tr>
  
  <tr>
    <td height="20">
      Run 4
    </td>
    
    <td>
      4769
    </td>
    
    <td>
      1299
    </td>
    
    <td>
      964
    </td>
    
    <td>
      1778
    </td>
    
    <td>
      1728
    </td>
  </tr>
  
  <tr>
    <td height="20">
      Run 5
    </td>
    
    <td>
      4416
    </td>
    
    <td>
      1665
    </td>
    
    <td>
      952
    </td>
    
    <td>
      1313
    </td>
    
    <td>
      1150
    </td>
  </tr>
</table>


<p><a href="http://udooz.github.io//blog/images/2012/04/ExtraSmall.png" rel="prettyPhoto[381]"><img class="alignnone size-full wp-image-396" title="ExtraSmall" src="http://udooz.github.io//blog/images/2012/04/ExtraSmall.png" alt="" width="481" height="289" /></a></p>

<h3>Small</h3>

<table width="461" border="0" cellspacing="0" cellpadding="0">
  <colgroup> <col span="4" width="64" /> <col width="66" /> <col width="139" /></colgroup> <tr>
    <td width="64" height="20">
    </td>
    
    <td width="64">
      Normal
    </td>
    
    <td width="64">
      Parallel
    </td>
    
    <td width="64">
      Async
    </td>
    
    <td width="66">
      Task
    </td>
    
    <td width="139">
      Task & ContinueWith
    </td>
  </tr>
  
  <tr>
    <td height="20">
      Run 1
    </td>
    
    <td>
      4044
    </td>
    
    <td>
      1319
    </td>
    
    <td>
      687
    </td>
    
    <td>
      2003
    </td>
    
    <td>
      2045
    </td>
  </tr>
  
  <tr>
    <td height="20">
      Run 2
    </td>
    
    <td>
      4116
    </td>
    
    <td>
      1229
    </td>
    
    <td>
      972
    </td>
    
    <td>
      2070
    </td>
    
    <td>
      1854
    </td>
  </tr>
  
  <tr>
    <td height="20">
      Run 3
    </td>
    
    <td>
      4060
    </td>
    
    <td>
      1468
    </td>
    
    <td>
      981
    </td>
    
    <td>
      1584
    </td>
    
    <td>
      1501
    </td>
  </tr>
  
  <tr>
    <td height="20">
      Run 4
    </td>
    
    <td>
      4375
    </td>
    
    <td>
      1316
    </td>
    
    <td>
      909
    </td>
    
    <td>
      1208
    </td>
    
    <td>
      1924
    </td>
  </tr>
  
  <tr>
    <td height="20">
      Run 5
    </td>
    
    <td>
      4167
    </td>
    
    <td>
      931
    </td>
    
    <td>
      797
    </td>
    
    <td>
      1272
    </td>
    
    <td>
      1109
    </td>
  </tr>
</table>


<p><a href="http://udooz.github.io//blog/images/2012/04/Small.png" rel="prettyPhoto[381]"><img class="alignnone size-full wp-image-399" title="Small" src="http://udooz.github.io//blog/images/2012/04/Small.png" alt="" width="481" height="289" /></a></p>

<h3>Medium</h3>

<table width="461" border="0" cellspacing="0" cellpadding="0">
  <colgroup> <col span="4" width="64" /> <col width="66" /> <col width="139" /></colgroup> <tr>
    <td width="64" height="20">
    </td>
    
    <td width="64">
      Normal
    </td>
    
    <td width="64">
      Parallel
    </td>
    
    <td width="64">
      Async
    </td>
    
    <td width="66">
      Task
    </td>
    
    <td width="139">
      Task & ContinueWith
    </td>
  </tr>
  
  <tr>
    <td height="20">
      Run 1
    </td>
    
    <td>
      4086
    </td>
    
    <td>
      1839
    </td>
    
    <td>
      933
    </td>
    
    <td>
      1326
    </td>
    
    <td>
      1385
    </td>
  </tr>
  
  <tr>
    <td height="20">
      Run 2
    </td>
    
    <td>
      4245
    </td>
    
    <td>
      1204
    </td>
    
    <td>
      751
    </td>
    
    <td>
      1069
    </td>
    
    <td>
      1064
    </td>
  </tr>
  
  <tr>
    <td height="20">
      Run 3
    </td>
    
    <td>
      4193
    </td>
    
    <td>
      1449
    </td>
    
    <td>
      753
    </td>
    
    <td>
      1176
    </td>
    
    <td>
      1291
    </td>
  </tr>
  
  <tr>
    <td height="20">
      Run 4
    </td>
    
    <td>
      4426
    </td>
    
    <td>
      1076
    </td>
    
    <td>
      619
    </td>
    
    <td>
      1300
    </td>
    
    <td>
      1395
    </td>
  </tr>
  
  <tr>
    <td height="20">
      Run 5
    </td>
    
    <td>
      4145
    </td>
    
    <td>
      811
    </td>
    
    <td>
      674
    </td>
    
    <td>
      888
    </td>
    
    <td>
      951
    </td>
  </tr>
</table>


<p><a href="http://udooz.github.io//blog/images/2012/04/Medium.png" rel="prettyPhoto[381]"><img title="Medium" src="http://udooz.github.io//blog/images/2012/04/Medium.png" alt="" width="481" height="289" /></a></p>

<h3>Large</h3>

<table width="461" border="0" cellspacing="0" cellpadding="0">
  <colgroup> <col span="4" width="64" /> <col width="66" /> <col width="139" /></colgroup> <tr>
    <td width="64" height="20">
    </td>
    
    <td width="64">
      Normal
    </td>
    
    <td width="64">
      Parallel
    </td>
    
    <td width="64">
      Async
    </td>
    
    <td width="66">
      Task
    </td>
    
    <td width="139">
      Task & ContinueWith
    </td>
  </tr>
  
  <tr>
    <td height="20">
      Run 1
    </td>
    
    <td>
      4124
    </td>
    
    <td>
      1269
    </td>
    
    <td>
      697
    </td>
    
    <td>
      1159
    </td>
    
    <td>
      1091
    </td>
  </tr>
  
  <tr>
    <td height="20">
      Run 2
    </td>
    
    <td>
      4013
    </td>
    
    <td>
      945
    </td>
    
    <td>
      892
    </td>
    
    <td>
      1028
    </td>
    
    <td>
      1299
    </td>
  </tr>
  
  <tr>
    <td height="20">
      Run 3
    </td>
    
    <td>
      4277
    </td>
    
    <td>
      977
    </td>
    
    <td>
      657
    </td>
    
    <td>
      1228
    </td>
    
    <td>
      1148
    </td>
  </tr>
  
  <tr>
    <td height="20">
      Run 4
    </td>
    
    <td>
      4322
    </td>
    
    <td>
      1270
    </td>
    
    <td>
      840
    </td>
    
    <td>
      820
    </td>
    
    <td>
      1072
    </td>
  </tr>
  
  <tr>
    <td height="20">
      Run 5
    </td>
    
    <td>
      4141
    </td>
    
    <td>
      1154
    </td>
    
    <td>
      729
    </td>
    
    <td>
      1059
    </td>
    
    <td>
      1151
    </td>
  </tr>
</table>


<p><a href="http://udooz.github.io//blog/images/2012/04/Large.png" rel="prettyPhoto[381]"><img title="Large" src="http://udooz.github.io//blog/images/2012/04/Large.png" alt="" width="481" height="289" /></a></p>

<p>Surprisingly, irrespective of the VM size, when an operation is I/O bound, asynchronous pattern outshines all the other approaches followed by Parallel.</p>

<h2>Final Words</h2>

<p>Hence, the &#8220;asynchronous&#8221; approach won the I/O bound operation (shown as a diagram also here).</p>

<p><a href="http://udooz.github.io//blog/images/2012/04/score.png" rel="prettyPhoto[381]"><img class="alignnone size-full wp-image-417" title="score" src="http://udooz.github.io//blog/images/2012/04/score.png" alt="" width="358" height="151" /></a></p>

<p>&nbsp;</p>

<p>Let me come up with one more test which covers on which area Parallel approach will shine.  In addition to these, when you have lesser I/O and want smooth multithreading, Task and Task + ContinueWith may help you.</p>

<p>What do you think? Share your thoughts!</p>

<p><strong>I highly thank  <a href="https://twitter.com/#!/smarx" target="_blank">Steve Marx</a> and <a href="https://twitter.com/#!/NunoGodinho" target="_blank">Nuno</a>  for validating my approach and the results which are actually improved my overall testing strategy.</strong></p>

<p>The source code is available at <a href="http://udooz.net/file-drive/doc_download/23-mailanalyzerasyncpoc.html" target="_blank"><a href="http://udooz.net/file-drive/doc_download/23-mailanalyzerasyncpoc.html">http://udooz.net/file-drive/doc_download/23-mailanalyzerasyncpoc.html</a></a><a style="display: none;" href="http://www.codeproject.com/script/Articles/BlogFeedList.aspx?amid=3057856" rel="tag">CodeProject</a></p>
</div>

<div class="meta">
	
</div>
</article>

	<div class="share">
	<div class="addthis_toolbox addthis_default_style ">
	
	
	<a class="addthis_button_tweet"></a>
	
	
	<a class="addthis_counter addthis_pill_style"></a>
	</div>
  <script type="text/javascript" src="http://s7.addthis.com/js/250/addthis_widget.js#pubid="></script>
</div>



    </div>
    <footer id="footer">
    <div style="display:inline">
    Copyright &copy; 2014

    M Sheik Uduman Ali
. Powered by <a href="http://octopress.org">Octopress</a> | 
    Theme <a href="http://github.com/panks/fabric">fabric</a> by <a href="http://panks.me">Pankaj Kumar</a>
</div>


    </footer>
    <script src="/blog/javascripts/fabric.js"></script>
<script src="/blog/javascripts/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
	$('.fancybox').fancybox();
})(jQuery);
</script> <!-- Delete or comment this line to disable Fancybox -->






<!-- end toload --> 
</div>
</div>
<script src="/javascripts/jquery.ui.totop.js" type="text/javascript"></script>
<script type="text/javascript">
/*<![CDATA[*/
;(function($){$().UItoTop({easingType:'easeOutCirc'});})(jQuery); 
/*]]>*/
</script><!-- remove it to remove the scroll to top button -->
</body>
</html>
