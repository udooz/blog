
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>WF: Exception Handling with State Machine Workflow - Udooz!</title>
  <meta name="author" content="M Sheik Uduman Ali">

  
  <meta name="description" content="Every day comes with some new wishes and challenges. Today my team struck up with handling in a state machine workflow. They digged the web for &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://udooz.github.io//blog/2008/06/wf-exception-handling-with-state-machine-workflow">
  <link href="/blog/favicon.png" rel="icon">
  <link href="/blog/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Udooz!" type="application/atom+xml">
  <script src="/blog/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/blog/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href='http://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet' type='text/css'>
<link href='http://fonts.googleapis.com/css?family=Fjalla+One' rel='stylesheet' type='text/css'>

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/blog/">Udooz!</a></h1>
  
    <h2>technologies.each { |tech| write_post(tech.facets) if tech.facets</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:udooz.github.io//blog" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/blog/">Blog</a></li>
  <li><a href="/blog/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">WF: Exception Handling with State Machine Workflow</h1>
    
    
      <p class="meta">
        








  


<time datetime="2008-06-24T00:00:00+05:30" pubdate data-updated="true"></time>
        
      </p>
    
  </header>


<div class="entry-content"><p><span>Every day comes with some new wishes and challenges. Today my team struck up with handling in a state machine workflow. They digged the web for finding a solution, unluck.</span><br/>
<span><span><strong>Problem</strong>: How to rethrow an exception from a state machine workflow to the workflow runtime host?</span></span><br/>
<span><strong>Description: </strong></span><span><span>I have designed one of our product as the service interface layer (WCF) invokes some of the business functionalities through workflow. We can say &#8220;workflow enabled business functionalities&#8221;. This is a state machine workflow (I don&#8217;t find real enterprise level usage of sequential workflow, of course you can use it at UI level). We have instrumented (exception handling and logging) well the non-workflow enabled services and business functionalities. Whenever a request comes from the clients of these services (currently, we have only one ASP.NET client) to perform a business operation, each layer do their responsibilities well. In case of any failure, they respond to the client gently with all necessary details. However, we were not able to handle exception in our &#8220;workflow enabled business functionalities&#8221;. Laughing&#8230;! Initially, I was also felt that we have missed something. After a while, my team found that this is the issue with WF itself. Actually, you can handle exception within the workflow runtime, but how can you respond to your client there is a fault while executing their requested business functionality. </span></span></p>

<p><span><span><span style="color:#cc0000;">By its asynchronous nature of state machine workflow, even though WF provides rethrow activity, it cannot propagate upto the calling place which is the host of the workflow instance</span>. This is common for any type of host such as Console, ASP.NET, etc.</span></span></p>

<p><span><strong>How to reproduce: </strong></span></p>

<p><span>1. Create a state machine workflow (for an example, RoseWorkflow) and add an event driven activity (onPluckFlowersEvent) on the initial state (Bud State).</span><br/>
<span>2. In the onPluckFlowersEvent handling code, forcefully throw an exception (<span style="font-family:courier new;">throw new Exception(&#8220;You cannot pluck flowers in this state&#8221;)</span>);. The value of the properties of this external event handler activity are:</span><br/>
<span style="font-family:courier new;font-size:85%;">Name: handlePluckFlowersEvent</span><br/>
<span style="font-family:courier new;font-size:85%;">InterfaceType: RoseIsRoseWorkflow.IRoseWorkflowService</span><br/>
<span style="font-family:courier new;font-size:85%;">EventName: PluckFlowers</span><br/>
<span style="font-family:courier new;font-size:85%;">e: Activity=RoseWorkflow, Path=EventArgs</span><br/>
<span style="font-family:courier new;font-size:85%;">sender: Activity=RoseWorkflow, Path=Sender</span><br/>
<span>For both sender and e, I&#8217;ve declared two properties named &#8220;EventArgs&#8221; of type ExternalDataEventArgs and &#8220;Sender&#8221; of type object. </span><br/>
<span></p> <figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">private</span> <span class="k">void</span> <span class="nf">handlePluckFlowersEvent_Invoked</span><span class="p">(</span><span class="kt">object</span> <span class="n">sender</span><span class="p">,</span> <span class="n">ExternalDataEventArgs</span> <span class="n">e</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="c1">// here <em>delegatedException is the member of   RoseWorkflow  </span>
</span><span class='line'>    <span class="n"></em>delegatedException</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Exception</span><span class="p">(</span><span class="s">&quot;In this stage, you cannot pluck flowers&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="k">throw</span> <span class="n">_delegatedException</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></p>

<p>
  </span><span>3. Add fault handler activity (onPluckFlowersEventFaultHandler) for the event and set its &#8220;FaultType&#8221; property as &#8220;System.Exception&#8221;.</span><br /> <span>4. If need, add normal code activity to handle the exception, like</span>
</p>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">private</span> <span class="k">void</span> <span class="nf">onPluckFlowersEventFaultCodeHandler_ExecuteCode</span><span class="p">(</span><span class="kt">object</span> <span class="n">sender</span><span class="p">,</span> <span class="n">EventArgs</span> <span class="n">e</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">FaultHandlerActivity</span> <span class="n">faultHandler</span> <span class="p">=</span> <span class="p">((</span><span class="n">Activity</span><span class="p">)</span><span class="n">sender</span><span class="p">).</span><span class="n">Parent</span> <span class="k">as</span> <span class="n">FaultHandlerActivity</span><span class="p">;</span>
</span><span class='line'>    <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&quot;Handle exception in workflow itself. Details: {0}&quot;</span><span class="p">,</span> <span class="n">faultHandler</span><span class="p">.</span><span class="n">Fault</span><span class="p">.</span><span class="n">Message</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>




<p>
  <span>5. Add Throw activity, and set the following properties:</span><br /> <span style="font-family:courier new;font-size:85%;">Fault: Activity=onPluckFlowersEventFaultHandler, Path=Fault</span><br /> <span style="font-family:courier new;font-size:85%;">FaultType: Activity=onPluckFlowersEventFaultHandler, Path=FaultType</span><br /> <span>6. Host it into a console:</span>
</p>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">class</span> <span class="nc">Program</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">static</span> <span class="k">void</span> <span class="nf">Main</span><span class="p">(</span><span class="kt">string</span><span class="p">[]</span> <span class="n">args</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>    <span class="n">using</span><span class="p">(</span><span class="n">WorkflowRuntime</span> <span class="n">workflowRuntime</span> <span class="p">=</span> <span class="k">new</span> <span class="n">WorkflowRuntime</span><span class="p">())</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>      <span class="n">AutoResetEvent</span> <span class="n">waitHandle</span> <span class="p">=</span> <span class="k">new</span> <span class="n">AutoResetEvent</span><span class="p">(</span><span class="k">false</span><span class="p">);</span>
</span><span class='line'>      <span class="n">workflowRuntime</span><span class="p">.</span><span class="n">WorkflowCompleted</span> <span class="p">+=</span> <span class="k">delegate</span><span class="p">(</span><span class="kt">object</span> <span class="n">sender</span><span class="p">,</span> <span class="n">WorkflowCompletedEventArgs</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span><span class="n">waitHandle</span><span class="p">.</span><span class="n">Set</span><span class="p">();};</span>
</span><span class='line'>      <span class="n">workflowRuntime</span><span class="p">.</span><span class="n">WorkflowTerminated</span> <span class="p">+=</span> <span class="k">delegate</span><span class="p">(</span><span class="kt">object</span> <span class="n">sender</span><span class="p">,</span> <span class="n">WorkflowTerminatedEventArgs</span> <span class="n">e</span><span class="p">)</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>        <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">Exception</span><span class="p">.</span><span class="n">Message</span><span class="p">);</span>
</span><span class='line'>        <span class="n">waitHandle</span><span class="p">.</span><span class="n">Set</span><span class="p">();</span>
</span><span class='line'>      <span class="p">};</span>
</span><span class='line'>      <span class="n">ExternalDataExchangeService</span> <span class="n">dataExchange</span> <span class="p">=</span> <span class="k">new</span> <span class="n">ExternalDataExchangeService</span><span class="p">();</span>
</span><span class='line'>      <span class="n">workflowRuntime</span><span class="p">.</span><span class="n">AddService</span><span class="p">(</span><span class="n">dataExchange</span><span class="p">);</span>
</span><span class='line'>      <span class="n">RoseWorkflowService</span> <span class="n">roseWorkflowService</span> <span class="p">=</span> <span class="k">new</span> <span class="n">RoseWorkflowService</span><span class="p">();</span>
</span><span class='line'>      <span class="n">dataExchange</span><span class="p">.</span><span class="n">AddService</span><span class="p">(</span><span class="n">roseWorkflowService</span><span class="p">);</span>
</span><span class='line'>      <span class="n">WorkflowInstance</span> <span class="n">instance</span> <span class="p">=</span> <span class="n">workflowRuntime</span><span class="p">.</span><span class="n">CreateWorkflow</span><span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="n">RoseWorkflow</span><span class="p">));</span>
</span><span class='line'>      <span class="n">instance</span><span class="p">.</span><span class="n">Start</span><span class="p">();</span>
</span><span class='line'>      <span class="n">roseWorkflowService</span><span class="p">.</span><span class="n">PluckFlowers</span> <span class="p">+=</span> <span class="k">new</span> <span class="n">EventHandler</span><span class="p">&lt;</span><span class="n">externaldataeventargs</span><span class="p">&gt;(</span><span class="n">roseWorkflowService_PluckFlowers</span><span class="p">);</span>
</span><span class='line'>      <span class="k">try</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>        <span class="n">roseWorkflowService</span><span class="p">.</span><span class="n">RaisePluckFlowersEvent</span><span class="p">(</span><span class="n">instance</span><span class="p">.</span><span class="n">InstanceId</span><span class="p">);}</span><span class="k">catch</span><span class="p">(</span><span class="n">Exception</span> <span class="n">e</span><span class="p">){</span><span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&quot;from host. {0},{1}&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">.</span><span class="n">GetType</span><span class="p">().</span><span class="n">Name</span><span class="p">,</span> <span class="n">e</span><span class="p">.</span><span class="n">Message</span><span class="p">);</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>      <span class="n">waitHandle</span><span class="p">.</span><span class="n">WaitOne</span><span class="p">();</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&quot;Press &lt;enter&gt;to quit&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="n">Console</span><span class="p">.</span><span class="n">ReadLine</span><span class="p">();</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="k">static</span> <span class="k">void</span> <span class="nf">roseWorkflowService_PluckFlowers</span><span class="p">(</span><span class="kt">object</span> <span class="n">sender</span><span class="p">,</span> <span class="n">ExternalDataEventArgs</span> <span class="n">e</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>    <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&quot;Handling PluckFlowers event&quot;</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="p">&lt;/</span><span class="n">enter</span><span class="p">&gt;&lt;/</span><span class="n">externaldataeventargs</span><span class="p">&gt;</span>
</span></code></pre></td></tr></table></div></figure>




<p>
  <span>I used RoseWorkflowService as one of my local service which implement my IRoseWorkflowService which is used in my workflow.</span><br /> <span>IRoseWorkflowService:</span>
</p>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="na">[ExternalDataExchange]</span>
</span><span class='line'><span class="k">public</span> <span class="k">interface</span> <span class="n">IRoseWorkflowService</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">event</span> <span class="n">EventHandler</span><span class="p">&lt;</span><span class="n">externaldataeventargs</span><span class="p">&gt;</span> <span class="n">PluckFlowers</span><span class="p">;</span>
</span><span class='line'>  <span class="k">void</span> <span class="nf">RaisePluckFlowersEvent</span><span class="p">(</span><span class="n">Guid</span> <span class="n">instanceId</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="p">&lt;/</span><span class="n">externaldataeventargs</span><span class="p">&gt;</span>
</span></code></pre></td></tr></table></div></figure>




<p>
  <span>RoseWorkflowService:</span>
</p>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="na">[Serializable]</span>
</span><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">RoseWorkflowService</span> <span class="p">:</span> <span class="n">IRoseWorkflowService</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="cp">#region IRoseWorkflowService Members</span>
</span><span class='line'>  <span class="k">public</span> <span class="k">event</span> <span class="n">EventHandler</span><span class="p">&lt;</span><span class="n">externaldataeventargs</span><span class="p">&gt;</span> <span class="n">PluckFlowers</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">public</span> <span class="k">void</span> <span class="nf">RaisePluckFlowersEvent</span><span class="p">(</span><span class="n">Guid</span> <span class="n">instanceId</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">PluckFlowers</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
</span><span class='line'>      <span class="n">PluckFlowers</span><span class="p">(</span><span class="k">null</span><span class="p">,</span> <span class="k">new</span> <span class="n">ExternalDataEventArgs</span><span class="p">(</span><span class="n">instanceId</span><span class="p">));</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="cp">#endregion</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="p">&lt;/</span><span class="n">externaldataeventargs</span><span class="p">&gt;</span>
</span></code></pre></td></tr></table></div></figure>




<p><p>
  <span>Now run the application. It never reaches to host place.</span><br /> <span><strong>Solution (Workaround)</strong>: You can resolve it through by &#8220;CallExternalMethod&#8221; activity. I will explain about this on next part with downloadable source code.</span> <div class="blogger-post-footer"></p>

<pre><code>&lt;img width='1' height='1' src='http://res1.blogblog.com/tracker/19892659-7254727202379327989?l=udooz.blogspot.com' /&gt;
</code></pre>

<p>  </div></p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">udooz</span></span>

      








  


<time datetime="2008-06-24T00:00:00+05:30" pubdate data-updated="true"></time>
      

<span class="categories">
  
    <a class='category' href='/blog/blog/categories/dot-net/'>.net</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="//twitter.com/share" class="twitter-share-button" data-url="http://udooz.github.io//blog/2008/06/wf-exception-handling-with-state-machine-workflow/" data-via="" data-counturl="http://udooz.github.io//blog/2008/06/wf-exception-handling-with-state-machine-workflow/" >Tweet</a>
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2008/06/wanna-more/" title="Previous Post: Wanna More">&laquo; Wanna More</a>
      
      
        <a class="basic-alignment right" href="/blog/2008/06/event-watch-moblin-intels-mobile-flavour/" title="Next Post: Event Watch: Moblin &#8211; Intel&#8217;s Mobile Flavour">Event Watch: Moblin &#8211; Intel&#8217;s Mobile Flavour &raquo;</a>
      
    </p>
  </footer>
</article>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2014/06/dont-use-elephant-for-your-garden-work/">Don&#8217;t use elephant for your garden work</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/04/unpacking-apache-storm-in-developer-box/">Unpacking Apache Storm in developer box</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/07/book-review-heroku-up-and-running-by-neil-richard-oreilly/">Book Review &#8211; Heroku up and running by Neil &#038; Richard &#8211; O&#8217;Reilly</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/07/book-review-see-what-i-mean-oreilly/">Book Review &#8211; See What I Mean &#8211; O&#8217;Reilly</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/07/adopting-event-sourcing-in-saas-using-windows-azure/">Adopting Event Sourcing in SaaS using Windows Azure</a>
      </li>
    
  </ul>
</section>





  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2014 - M Sheik Uduman Ali -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
